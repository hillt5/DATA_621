---
title: "Data 621 - HW4"
author: "Devin Teran, Atina Karim, Tom Hill, Amit Kapoor"
date: "5/2/2021"
output:
  pdf_document:
    toc: TRUE
    toc_depth: 2 
  html_document:
    highlight: pygments
    number_sections: no
    theme: flatly
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, error=FALSE, warning=FALSE, message=FALSE)
```

```{r libraries, include=FALSE}


# Libraries


library(stringr)
library(tidyr)
library(DataExplorer)        
library(dplyr)
library(visdat)
library(pROC)
library(mice)
library(corrplot)
library(MASS)
library(caret)
library(e1071)


library(GGally)
library(ggplot2)
library(readr)
library(reshape2)
library(purrr)

set.seed(2012)


```


```{r data}
insurance <- read.csv('https://raw.githubusercontent.com/hillt5/DATA_621/master/HW4/insurance_training_data.csv', stringsAsFactors =  FALSE)
```

Variable Descriptions:

AGE Age of Driver 
BLUEBOOK Value of Vehicle
CAR_AGE Vehicle Age 
CAR_TYPE Type of Car
CAR_USE Vehicle Use
CLM_FREQ # Claims (Past 5 Years)
EDUCATION Max Education Level
HOMEKIDS # Children at Home 
HOME_VAL Home Value 
INCOME Income
JOB Job Category
KIDSDRIV Number of Driving Children 
MSTATUS Marital Status 
MVR_PTS Motor Vehicle Record Points 
OLDCLAIM Total Claims (Past 5 Years)  
PARENT1 Single Parent  
RED_CAR A Red Car  
REVOKED License Revoked (Past 7 Years)  
SEX Gender  
TIF Time in Force 
TRAVTIME Distance to Work 
URBANICITY Home/Work Area 
YOJ Years on Job  


```{r, before-fix}

head(insurance)
summary(insurance)

insurance_fix <- dplyr::select(insurance, -INDEX)

```

There are several recurring isues with some columns: all columns containing money amounts have incomptaible punctuation and characters. Also, categorical variables neeed to be changed to factors and their 


```{r, numeric-vars}

insurance_fix$HOME_VAL <- substr(insurance_fix$HOME_VAL, 2, nchar(insurance_fix$HOME_VAL))
insurance_fix$HOME_VAL <- as.numeric(str_remove_all(insurance_fix$HOME_VAL, "[[:punct:]]"))

insurance_fix$BLUEBOOK<- substr(insurance_fix$BLUEBOOK , 2, nchar(insurance_fix$BLUEBOOK ))
insurance_fix$BLUEBOOK<- as.numeric(str_remove_all(insurance_fix$BLUEBOOK,"[[:punct:]]"))

insurance_fix$INCOME  <- substr(insurance_fix$INCOME, 2, nchar(insurance_fix$INCOME))
insurance_fix$INCOME <- as.numeric(str_remove_all(insurance_fix$INCOME, "[[:punct:]]"))

insurance_fix$OLDCLAIM <- substr(insurance_fix$OLDCLAIM, 2, nchar(insurance_fix$OLDCLAIM))
insurance_fix$OLDCLAIM <- as.numeric(str_remove_all(insurance_fix$OLDCLAIM, "[[:punct:]]"))

```


```{r, categorical-vars}

insurance_fix$MSTATUS = as.factor(str_remove(insurance_fix$MSTATUS, 'z_'))
insurance_fix$PARENT1 = as.factor(str_remove(insurance_fix$PARENT1, 'z_'))
insurance_fix$EDUCATION = str_remove(insurance_fix$EDUCATION, '<')
insurance_fix$SEX= as.factor(str_remove(insurance_fix$SEX, 'z_'))
insurance_fix$EDUCATION = as.factor(str_remove(insurance_fix$EDUCATION, 'z_'))
insurance_fix$JOB = as.factor(str_remove(insurance_fix$JOB, 'z_'))
insurance_fix$CAR_USE = as.factor(str_remove(insurance_fix$CAR_USE, 'z_'))
insurance_fix$CAR_TYPE = as.factor(str_remove(insurance_fix$CAR_TYPE, 'z_'))
insurance_fix$URBANICITY = as.factor(str_remove(insurance_fix$URBANICITY, 'z_'))
insurance_fix$REVOKED = as.factor(str_remove(insurance_fix$REVOKED, 'z_'))
insurance_fix$RED_CAR = as.factor(str_remove(insurance_fix$RED_CAR, 'z_'))
```


```{r, after-fix}

summary(insurance_fix)

```

Car age appears to have some values less than 1, including a negative values. These will be chnaged to the mode of 1.
```{r, car-age}

insurance_fix$CAR_AGE[insurance_fix$CAR_AGE <1] <- 1


```


```{r, levels}

for (i in 4:ncol(insurance_fix)) {
  if (class((insurance_fix[,i])) == 'factor') {
      print(levels(insurance_fix[,i]))
  }

}

```


The only remaining issue are blank values for some entries in the 'JOB' column.


```{r, missing-values}

round(colSums(is.na(insurance_fix))/nrow(insurance_fix),3)

vis_dat(insurance_fix %>% dplyr:: select(YOJ, INCOME, HOME_VAL, CAR_AGE))


```

```{r, histograms}


plot_histogram(insurance_fix)


```


Threre are several variables with zero as a mode. This may indicate coding as misisng or incomplete variable. The variables I'm concerned with are ones that have normal or skewed distributions with the exception of values equal to zero. These include CAR_AGE, HOME_VAL, INCOME, and YOJ.  For all four of these variables, interpretation of zero is further complicated by NA's already existing in this dataset. Several other variables have a mode of zero but are more likely to be counts, like KIDSDRIV and MVR_PTS. Also, OLDCLAIM is a variable related to CLM_FREQ in that OLDCLAIM is equal to zero when CLM_FREQ is zero. 


```{r, zero-vals}

insurance_zeroes <- insurance_fix

insurance_zeroes$HOME_VAL[insurance_zeroes$HOME_VAL == 0] <- NA
insurance_zeroes$INCOME[insurance_zeroes$INCOME == 0] <- NA
insurance_zeroes$CAR_AGE[insurance_zeroes$CAR_AGE == 0] <- NA
insurance_zeroes$YOJ[insurance_zeroes$YOJ == 0] <- NA

```


```{r, zero-val-viz}


round(colSums(is.na(insurance_zeroes))/nrow(insurance_zeroes),3)

vis_dat(insurance_zeroes %>% dplyr:: select(YOJ, INCOME, HOME_VAL, CAR_AGE))
```

Treating zeroes as NA, this increases the overlap between missing values and causes HOME_VAL to have approximately 30% missing values.







```{r, first-model}


insurance_logistic_model <- glm(insurance_fix, family = 'binomial', formula = TARGET_FLAG~.-TARGET_AMT)

summary(insurance_logistic_model)

```




```{r, performance-function}
get_cv_performance <- function(data_frame, model, split = 0.8) {  ### input is dataframe for partitioning, model as generated by 'glm' function, by default 5-fold cross-validation
  n <- ncol(data_frame) #number of columns in original dataframe
  train_control <- trainControl(method="repeatedcv", number=10, repeats=3)
  trainIndex <- createDataPartition(data_frame[,n], p=split, list=FALSE)
  data_train <- data_frame[trainIndex,]
  data_test <- data_frame[-trainIndex,]
  
  x_test <- data_test[,2:n] #explanatory variables
  y_test <- data_test[,1]  #response variable
  predictions <- predict(model, x_test, type = 'response')
  
  return(confusionMatrix(data = (as.factor(as.numeric(predictions>0.5))), reference = as.factor(y_test)))
  
  return(plot(roc(y_test, predictions),print.auc=TRUE))
  
}
```


```{r, roc-function}
get_roc <- function(data_frame, model, split = 0.8) {  ### input is dataframe for partitioning, model as generated by 'glm' function
  n <- ncol(data_frame) #number of columns in original dataframe
  train_control <- trainControl(method="repeatedcv", number=10, repeats=3)
  trainIndex <- createDataPartition(data_frame[,n], p=split, list=FALSE)
  data_train <- data_frame[trainIndex,]
  data_test <- data_frame[-trainIndex,]
  
  x_test <- data_test[,2:n] #explanatory variables
  y_test <- data_test[,1]  #response variable
  predictions <- predict(model, x_test, type = 'response')
  return(plot(roc(y_test, predictions),print.auc=TRUE))
  
}
```




```{r, logistic-model-performance}

get_cv_performance(insurance_fix, insurance_logistic_model)
get_roc(insurance_fix, insurance_logistic_model)


```



```{r, imputed-model}

insurance_impute <- mice(insurance_fix, method = 'cart', m = 1)

imputed_lm <- glm.mids(data = insurance_impute, formula = TARGET_FLAG ~.-TARGET_AMT, family = 'binomial')


imputed_lm

```



```{r, imputed-model-performance}

get_cv_performance(insurance_fix, imputed_lm$analyses[[1]])
get_roc(insurance_fix, imputed_lm$analyses[[1]])


```







